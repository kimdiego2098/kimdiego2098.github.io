"use strict";(self.webpackChunkthingsgateway=self.webpackChunkthingsgateway||[]).push([[7825],{8359:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>i,default:()=>p,frontMatter:()=>r,metadata:()=>l,toc:()=>u});var a=t(7462),s=(t(7294),t(3905));t(4996),t(510),t(2969);const r={id:30002,title:"\u7b80\u5355\u5b9e\u7528\u7684Modbus\u7c7b\u5e93"},i=void 0,l={unversionedId:"30002",id:"30002",title:"\u7b80\u5355\u5b9e\u7528\u7684Modbus\u7c7b\u5e93",description:"\u4e00\u3001\u7b80\u4ecb",source:"@site/docs/30002.mdx",sourceDirName:".",slug:"/30002",permalink:"/docs/30002",draft:!1,editUrl:"https://gitee.com/diego2098/ThingsGateway/tree/master/doc/docs/30002.mdx",tags:[],version:"current",frontMatter:{id:"30002",title:"\u7b80\u5355\u5b9e\u7528\u7684Modbus\u7c7b\u5e93"},sidebar:"docs",previous:{title:"\u4e32\u53e3",permalink:"/docs/30001"},next:{title:"\u8054\u7cfb\u6211\u4eec",permalink:"/docs/1002"}},o={},u=[{value:"\u4e00\u3001\u7b80\u4ecb",id:"\u4e00\u7b80\u4ecb",level:2},{value:"\u4e8c\u3001nuget\u5b89\u88c5",id:"\u4e8cnuget\u5b89\u88c5",level:2},{value:"\u4e09\u3001\u4f7f\u7528\u6307\u5357",id:"\u4e09\u4f7f\u7528\u6307\u5357",level:2},{value:"3.1\u3001\u521b\u5efa\u901a\u9053",id:"31\u521b\u5efa\u901a\u9053",level:3},{value:"3.2\u3001\u521b\u5efa\u534f\u8bae\u7c7b",id:"32\u521b\u5efa\u534f\u8bae\u7c7b",level:3},{value:"modbus\u4e3b\u7ad9",id:"modbus\u4e3b\u7ad9",level:4},{value:"modbus\u4ece\u7ad9",id:"modbus\u4ece\u7ad9",level:4},{value:"3.3\u3001\u8bfb\u5199",id:"33\u8bfb\u5199",level:3},{value:"\u8bfb\u53d6",id:"\u8bfb\u53d6",level:4},{value:"\u5199\u5165",id:"\u5199\u5165",level:4},{value:"3.4\u3001\u6253\u5305\u8bfb\u53d6",id:"34\u6253\u5305\u8bfb\u53d6",level:3},{value:"IVariable\u63a5\u53e3\u5b9e\u73b0",id:"ivariable\u63a5\u53e3\u5b9e\u73b0",level:4},{value:"VariableObject\u5b9e\u4f53\u7c7b\u5b9e\u73b0",id:"variableobject\u5b9e\u4f53\u7c7b\u5b9e\u73b0",level:4},{value:"\u5b9e\u4f53\u7c7b\u914d\u7f6e\u5c5e\u6027VariableRuntime\u7279\u6027",id:"\u5b9e\u4f53\u7c7b\u914d\u7f6e\u5c5e\u6027variableruntime\u7279\u6027",level:5},{value:"\u56db\u3001\u6027\u80fd\u6d4b\u8bd5",id:"\u56db\u6027\u80fd\u6d4b\u8bd5",level:2},{value:"\u4e94\u3001\u603b\u7ed3",id:"\u4e94\u603b\u7ed3",level:2}],d={toc:u},c="wrapper";function p(e){let{components:n,...r}=e;return(0,s.kt)(c,(0,a.Z)({},d,r,{components:n,mdxType:"MDXLayout"}),(0,s.kt)("h2",{id:"\u4e00\u7b80\u4ecb"},"\u4e00\u3001\u7b80\u4ecb"),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"ThingsGateway.Foundation.Modbus")," \u7528\u4e8eModbus\u534f\u8bae\u901a\u8baf\uff0c\u652f\u6301",(0,s.kt)("strong",{parentName:"p"},"\u4e3b\u7ad9/\u4ece\u7ad9\u3001ModbusTcp/ModbusRtu\uff0c\u901a\u8baf\u94fe\u8def\u652f\u6301\u4e32\u53e3/Tcp/Udp\u3001\u88ab\u52a8\u8fde\u63a5(Dtu)")),(0,s.kt)("p",null,"\u4f18\u52bf\uff1a"),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"1\u3001\u901a\u8baf\u94fe\u8def\u4e0e\u534f\u8bae\u89e3\u6790\u7c7b\u677e\u8026\u5408\u8bbe\u8ba1")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"2\u3001\u652f\u6301\u88ab\u52a8\u8fde\u63a5(Dtu)\u8bbe\u5907")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"3\u3001\u5185\u7f6e\u6253\u5305\u7b97\u6cd5")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"4\u3001\u5b9e\u4f53\u901a\u8baf\u7ed3\u679c\u6620\u5c04\uff0c\u5e76\u652f\u6301\u6253\u5305\u8fde\u8bfb")),(0,s.kt)("h2",{id:"\u4e8cnuget\u5b89\u88c5"},"\u4e8c\u3001nuget\u5b89\u88c5"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},'<PackageReference Include="ThingsGateway.Foundation.Modbus" Version="6.0.3.47" />\n')),(0,s.kt)("h2",{id:"\u4e09\u4f7f\u7528\u6307\u5357"},"\u4e09\u3001\u4f7f\u7528\u6307\u5357"),(0,s.kt)("h3",{id:"31\u521b\u5efa\u901a\u9053"},"3.1\u3001\u521b\u5efa\u901a\u9053"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},' var clientConfig = new TouchSocketConfig();\n //tcp\u670d\u52a1\n //var clientChannel = clientConfig.GetTcpServiceWithBindIPHost("tcp://127.0.0.1:502");\n //\u4e32\u53e3\n //var clientChannel = clientConfig.GetSerialPortWithOption("COM1");\n //udp\n //var clientChannel = clientConfig.GetUdpSessionWithIPHost("127.0.0.1:502",null);\n\n //tcp\u5ba2\u6237\u7aef\n var clientChannel = clientConfig.GetTcpClientWithIPHost("127.0.0.1:502");\n\n')),(0,s.kt)("h3",{id:"32\u521b\u5efa\u534f\u8bae\u7c7b"},"3.2\u3001\u521b\u5efa\u534f\u8bae\u7c7b"),(0,s.kt)("h4",{id:"modbus\u4e3b\u7ad9"},"modbus\u4e3b\u7ad9"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"}," ModbusMaster modbusMaster = new(clientChannel)\n {\n     //modbus\u534f\u8bae\u683c\u5f0f\n     ModbusType = Modbus.ModbusTypeEnum.ModbusRtu,\n     //ModbusType = Modbus.ModbusTypeEnum.ModbusTcp,\n\n     //\u9ed8\u8ba4\u7ad9\u53f7\n     Station = 1,\n     //\u9ed8\u8ba4\u6570\u636e\u683c\u5f0f\n     DataFormat = DataFormatEnum.ABCD,\n     //\u8bfb\u5199\u8d85\u65f6\n     Timeout = 3000,\n };\n\n")),(0,s.kt)("h4",{id:"modbus\u4ece\u7ad9"},"modbus\u4ece\u7ad9"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"ModbusSlave modbusSlave = new(clientChannel)\n{\n    //modbus\u534f\u8bae\u683c\u5f0f\n    ModbusType = Modbus.ModbusTypeEnum.ModbusRtu,\n    //ModbusType = Modbus.ModbusTypeEnum.ModbusTcp,\n\n    //\u9ed8\u8ba4\u7ad9\u53f7\n    Station = 1,\n    //\u9ed8\u8ba4\u6570\u636e\u683c\u5f0f\n    DataFormat = DataFormatEnum.ABCD,\n};\n\n")),(0,s.kt)("h3",{id:"33\u8bfb\u5199"},"3.3\u3001\u8bfb\u5199"),(0,s.kt)("h4",{id:"\u8bfb\u53d6"},"\u8bfb\u53d6"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},'//\u5355\u72ec\u8bfb\u53d6Int16\u7c7b\u578b\uff0c\u5176\u4ed6\u7c7b\u578b\u64cd\u4f5c\u7c7b\u4f3c\nvar data = await modbusMaster.ReadInt16Async("40001");\n//\u6279\u91cf\u8bfb\u53d6Int16\u7c7b\u578b\uff0c\u5176\u4ed6\u7c7b\u578b\u64cd\u4f5c\u7c7b\u4f3c\nvar data = await modbusMaster.ReadInt16Async("40001", 10);\n\n//\u5bf9\u4e8e4\u5b57\u8282\u7684\u89e3\u6790\u89c4\u5219\uff0c\u53ef\u5728\u534f\u8bae\u7c7b\u4e2d\u8bbe\u7f6e ``DataFormat`` \u5c5e\u6027\uff0c\u4e5f\u53ef\u4ee5\u8bfb\u53d6\u65b9\u5f0f\u65f6\u4f20\u5165\u5b57\u7b26\u4e32\nvar data = await modbusMaster.ReadSingleAsync("40001;data=ABCD");\n\n//\u4f20\u5165\u7684\u5bc4\u5b58\u5668\u5730\u5740\u89c4\u5219\uff0c\u53ef\u4ee5\u901a\u8fc7\u6587\u6863\u67e5\u770b\uff0c\u6216\u8005\u8c03\u7528GetAddressDescription\u65b9\u6cd5\n//\u67e5\u770bmodbus\u9a71\u52a8\u5730\u5740\u8bf4\u660e\nConsole.WriteLine(modbusMaster.GetAddressDescription());\n\n\n//\u6279\u91cf\u8bfb\u53d6\u5b57\u8282\u6570\u7ec4\nvar data = await modbusMaster.ReadAsync("40001", 10);\n//\u4e5f\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7\u5b57\u8282\u6570\u7ec4\uff0c\u83b7\u53d6\u9700\u8981\u7684\u6570\u636e\u7c7b\u578b\nif(data.IsSuccess)\n{\n    ValueByteBlock valueByteBlock = new(data.Content);\n    //\u8bfb\u53d6float\n    valueByteBlock.ReadFloat(EndianType.LittleSwap);\n}\n\n\n')),(0,s.kt)("h4",{id:"\u5199\u5165"},"\u5199\u5165"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},'//\u8c03\u7528WriteAsync\u65b9\u6cd5\nvar result = await modbusMaster.WriteAsync("40001",(ushort)1);\n\n')),(0,s.kt)("h3",{id:"34\u6253\u5305\u8bfb\u53d6"},"3.4\u3001\u6253\u5305\u8bfb\u53d6"),(0,s.kt)("h4",{id:"ivariable\u63a5\u53e3\u5b9e\u73b0"},"IVariable\u63a5\u53e3\u5b9e\u73b0"),(0,s.kt)("p",null,"1\u3001\u5b9e\u73b0IVariable\u63a5\u53e3"),(0,s.kt)("p",null,"2\u3001\u5b9e\u73b0IVariableSource\u63a5\u53e3"),(0,s.kt)("p",null,"3\u3001\u8c03\u7528LoadSourceRead\uff0c\u8fd4\u56de\u6253\u5305\u5c01\u88c5\u7c7b"),(0,s.kt)("p",null,"4\u3001\u8c03\u7528ReadAsync\u8bfb\u53d6\u6570\u636e\uff0c\u5e76\u8c03\u7528PraseStructContent\u89e3\u6790\u6570\u636e"),(0,s.kt)("p",null,"5\u3001\u89e3\u6790\u6570\u636e\u540e\uff0c\u53ef\u4ee5\u901a\u8fc7IVariable\u83b7\u53d6\u89e3\u6790\u540e\u7684\u6570\u636e"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},'\n //\u901a\u8fc7\u6570\u636e\u5e93\u7b49\u65b9\u5f0f\u83b7\u53d6\u5bc4\u5b58\u5668/\u6570\u636e\u7c7b\u578b\u7b49\u914d\u7f6e\n List<VariableClass> variableClasses = new()\n {\n     new VariableClass()\n     {\n         DataType=DataTypeEnum.Int16,\n         RegisterAddress="40001",\n         IntervalTime=1000,\n     },\n         new VariableClass()\n     {\n         DataType=DataTypeEnum.Int32,\n         RegisterAddress="40011",\n         IntervalTime=1000,\n     },\n };\n //\u8c03\u7528LoadSourceRead\uff0c\u8fd4\u56de\u6253\u5305\u5c01\u88c5\u7c7b\n var deviceVariableSourceReads = modbusMaster.LoadSourceRead<VariableSourceClass>(variableClasses, 100, 1000);\n\n //IVariableSource\u5217\u8868\uff0c\u8c03\u7528ReadAsync\u8bfb\u53d6\u5b57\u8282\u6570\u636e\uff0c\u5e76\u8c03\u7528PraseStructContent\u89e3\u6790\u6570\u636e\n foreach (var item in deviceVariableSourceReads)\n {\n     var result = await modbusMaster.ReadAsync(item.RegisterAddress, item.Length);\n     if (result.IsSuccess)\n     {\n         try\n         {\n             var result1 = item.VariableRunTimes.PraseStructContent(modbusMaster, result.Content, exWhenAny: true);\n             if (!result1.IsSuccess)\n             {\n                //\u5931\u8d25\u65e5\u5fd7\n                 item.LastErrorMessage = result1.ErrorMessage;\n                 item.VariableRunTimes.ForEach(a => a.SetValue(null, isOnline: false));\n                 modbusMaster.Logger.Warning(result1.ToString());\n             }\n         }\n         catch (Exception ex)\n         {\n             modbusMaster.Logger.Exception(ex);\n         }\n     }\n     else\n     {\n        //\u901a\u8baf\u5931\u8d25\u65e5\u5fd7\n         item.LastErrorMessage = result.ErrorMessage;\n         item.VariableRunTimes.ForEach(a => a.SetValue(null, isOnline: false));\n         modbusMaster.Logger.Warning(result.ToString());\n     }\n }\n\n')),(0,s.kt)("h4",{id:"variableobject\u5b9e\u4f53\u7c7b\u5b9e\u73b0"},"VariableObject\u5b9e\u4f53\u7c7b\u5b9e\u73b0"),(0,s.kt)("p",null,"1\u3001\u5b9e\u73b0VariableObject\u865a\u7c7b\uff0c\u6dfb\u52a0\u4e1a\u52a1\u5c5e\u6027\uff0c\u4e1a\u52a1\u5c5e\u6027\u9700\u6dfb\u52a0VariableRuntime\u7279\u6027\uff0c\u6307\u5b9a\u5bc4\u5b58\u5668\u5730\u5740\u3001\u7279\u5b9a\u6570\u636e\u7c7b\u578b(\u4e0d\u586b\u9ed8\u8ba4\u4e3aC#\u5c5e\u6027\u7c7b\u578b)\u3001\u8bfb\u5199\u8868\u8fbe\u5f0f(\u539f\u59cb\u503c\u4e3araw\uff0c\u53ef\u586b\uff1araw*100+10\uff0c\u505a\u4e00\u4e9b\u6570\u5b66\u8f6c\u6362))"),(0,s.kt)("p",null,"2\u3001\u5b9e\u4f8b\u5316\u4e1a\u52a1\u5b9e\u4f53\u7c7b\uff0c\u9700\u4f20\u5165\u534f\u8bae\u5bf9\u8c61\u4e0e\u8fde\u8bfb\u6253\u5305\u7684\u6700\u5927\u6570\u91cf"),(0,s.kt)("p",null,"3\u3001\u53ef\u4ee5\u770b\u5230\u6e90\u4ee3\u7801\u751f\u6210\u5668\u5df2\u7ecf\u81ea\u52a8\u751f\u6210\u4e86\u5199\u5165\u65b9\u6cd5\uff0c\u53ef\u76f4\u63a5\u8c03\u7528WriteAlarmLimitAsync\u6cd5\u5199\u5165\u6570\u636e"),(0,s.kt)("p",null,"4\u3001\u8c03\u7528MultiReadAsync\u65b9\u6cd5\u6267\u884c\u8fde\u8bfb\uff0c\u7ed3\u679c\u4f1a\u81ea\u52a8\u89e3\u6790\u5230\u4e1a\u52a1\u5b9e\u4f53\u7c7b\u7684\u5c5e\u6027\u4e2d"),(0,s.kt)("h5",{id:"\u5b9e\u4f53\u7c7b\u914d\u7f6e\u5c5e\u6027variableruntime\u7279\u6027"},"\u5b9e\u4f53\u7c7b\u914d\u7f6e\u5c5e\u6027VariableRuntime\u7279\u6027"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},'\n[GeneratorVariable]\npublic partial class ModbusVariable : VariableObject\n{\n    [VariableRuntime(RegisterAddress = "400051",ReadExpressions ="raw*10")]\n    public ushort AlarmLevel { get; set; }\n\n    [VariableRuntime(RegisterAddress = "400061;len=10")]\n    public string AlarmText { get; set; }\n\n    [VariableRuntime(RegisterAddress = "400071")]\n    public float AlarmLimit { get; set; }\n\n    public ModbusVariable(IProtocol protocol, int maxPack) : base(protocol, maxPack)\n    {\n    }\n}\n\n')),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"\n//\u6784\u9020\u5b9e\u4f53\u7c7b\u5bf9\u8c61\uff0c\u4f20\u5165\u534f\u8bae\u5bf9\u8c61\u4e0e\u8fde\u8bfb\u6253\u5305\u7684\u6700\u5927\u6570\u91cf\nModbusVariable modbusVariable = new(modbusMaster, 100);\n\n//\u8bfb\u53d6\uff0c\u6210\u529f\u7ed3\u679c\u4f1a\u6620\u5c04\u5230\u5b9e\u4f53\u5c5e\u6027\u4e2d\nvar result= await modbusVariable.MultiReadAsync();\n\n //\u5199\u5165\n //\u6e90\u751f\u6210\u5668\u81ea\u52a8\u751f\u6210\u4e86``(Write{\u5c5e\u6027\u540d\u79f0})Async``\u65b9\u6cd5\uff0c\u76f4\u63a5\u8c03\u7528\u5373\u53ef\n await modbusVariable.WriteAlarmLimitAsync(100);\n \n //\u8f93\u51fa\u5b9e\u4f53json\u67e5\u770b\nConsole.WriteLine(modbusVariable.ToJsonString());\n\n\n")),(0,s.kt)("h2",{id:"\u56db\u6027\u80fd\u6d4b\u8bd5"},"\u56db\u3001\u6027\u80fd\u6d4b\u8bd5"),(0,s.kt)("p",null,"\u4e0b\u9762\u53ef\u4ee5\u770b\u5230\u4e0eHslCommunication\u7684\u57fa\u51c6\u6d4b\u8bd5\u5bf9\u6bd4"),(0,s.kt)("p",null,"\u91c7\u96c6100\u4e2a\u8fde\u7eed\u5bc4\u5b58\u5668\uff0c\u91c7\u7528ModSim32\u4f5c\u4e3a\u6d4b\u8bd5\u6a21\u62df\u8bbe\u5907\u7aef"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},'\n    [Benchmark]\n    public async Task ThingsGateway()\n    {\n        for (int i = 0; i < Program.NumberOfItems; i++)\n        {\n            var result = await thingsgatewaymodbus.ReadAsync("40001", 100);\n            if (!result.IsSuccess)\n            {\n                throw new Exception(result.ToString());\n            }\n        }\n    }\n\n    [Benchmark]\n    public async Task HslCommunication()\n    {\n        for (int i = 0; i < Program.NumberOfItems; i++)\n        {\n            var result = await modbusTcpNet.ReadAsync("0", 100);\n            if (!result.IsSuccess)\n            {\n                throw new Exception(result.Message);\n            }\n        }\n    }\n\n')),(0,s.kt)("img",{src:t(3330).Z}),(0,s.kt)("p",null,"\u5f97\u76ca\u4e8e\u5b57\u8282\u6c60\u4e0eSocket\u5f02\u6b65\uff0c\u867d\u7136\u90fd\u91c7\u7528\u5b57\u7b26\u4e32\u89e3\u6790\u5bc4\u5b58\u5668\u5730\u5740\u7684\u65b9\u5f0f\uff0c\u4f46ThingsGateway\u7684\u5185\u5b58\u8017\u7528\u6bd4\u8f83\u4f4e\uff0c\u5e76\u4e14\u91c7\u96c6\u901a\u8baf\u901f\u5ea6\u66f4\u5feb"),(0,s.kt)("h2",{id:"\u4e94\u603b\u7ed3"},"\u4e94\u3001\u603b\u7ed3"),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"ThingsGateway.Foundation.Modbus"),"\uff0c\u975e\u5e38\u597d\u7528\u7684modbus\u534f\u8bae\u5e93\uff0c\u5c24\u5176\u662f\u5b9e\u4f53\u901a\u8baf\u7c7b\u4ee5\u53ca\u81ea\u52a8\u6253\u5305\u7684\u529f\u80fd\uff0c\u975e\u5e38\u9002\u7528\u4e8e\u4e0a\u4f4d\u673a\u4e1a\u52a1\u4f7f\u7528\u3002"),(0,s.kt)("p",null,"Gitee\u4ed3\u5e93\u5730\u5740 ",(0,s.kt)("a",{parentName:"p",href:"https://gitee.com/diego2098/ThingsGateway"},"https://gitee.com/diego2098/ThingsGateway")," "),(0,s.kt)("p",null,"Github\u4ed3\u5e93\u5730\u5740 ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/kimdiego2098/ThingsGateway"},"https://github.com/kimdiego2098/ThingsGateway")))}p.isMDXComponent=!0},3330:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/ModbusBenchMark-4760152fc34091182801765ee72652ba.png"}}]);